<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="ENNOVI PNLè´¢åŠ¡åˆ†æä¸æ”¹å–„æ¨¡æ‹Ÿå·¥å…· - é›†æˆè´¢åŠ¡æŒ‡æ ‡åˆ†æã€æ”¹å–„æ–¹æ¡ˆè§„åˆ’å’Œæ•ˆæœæ¨¡æ‹Ÿ">
    <meta name="theme-color" content="#0F0F6D">
    <meta name="format-detection" content="telephone=no">
    <meta name="color-scheme" content="light">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <!-- Print styles -->
    <style media="print">
        @page {
            size: A4;
            margin: 2cm;
        }
        
        body {
            width: 100%;
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }

        .simulation-table, .comparison-table {
            page-break-inside: avoid;
        }

        .pie-charts-container {
            page-break-before: always;
            display: block;
        }

        .pie-chart-wrapper {
            width: 100%;
            page-break-inside: avoid;
            margin-bottom: 2cm;
        }

        .improvement-card {
            page-break-inside: avoid;
        }

        .button-container, .batch-control {
            display: none;
        }

        @media print and (color) {
            * {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>

    <!-- Accessibility improvements -->
    <style>
        *:focus {
            outline: 3px solid var(--color-tertiary);
            outline-offset: 2px;
        }

        .skip-to-main {
            position: absolute;
            left: -9999px;
            z-index: 999;
            padding: 1em;
            background-color: white;
            color: var(--color-primary);
            text-decoration: none;
        }

        .skip-to-main:focus {
            left: 50%;
            transform: translateX(-50%);
            top: 0;
        }

        [role="button"],
        [role="tab"],
        [tabindex="0"] {
            cursor: pointer;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>ENNOVI PNL åˆ†ææŒ‡å¯¼æ‰‹å†Œ</title>
    <style>
        /* Mobile optimizations */
        html {
            -webkit-overflow-scrolling: touch;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        button, input, select {
            min-height: 44px;
            touch-action: manipulation;
        }

        :root {
            --color-primary: #0F0F6D;
            --color-secondary: #A100FF;
            --color-tertiary: #00B5F7;
            --color-quaternary: #FF4F8F;
            --color-quinary: #7B61FF;
            --color-senary: #00D9C5;
            --color-septenary: #FFB800;
            --color-octonary: #1CA37D;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            background-color: var(--color-primary);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        @media (max-width: 1240px) {
            .container {
                max-width: 100%;
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .section {
                padding: 15px;
                margin-bottom: 20px;
            }

            .section-title {
                font-size: 18px;
            }

            .pie-charts-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .simulation-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .comparison-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .batch-control {
                flex-direction: column;
                gap: 15px;
            }

            .batch-content,
            .batch-input-wrapper,
            .batch-apply {
                width: 100%;
            }

            .button-container {
                flex-direction: column;
                gap: 10px;
            }

            .simulation-submit,
            .simulation-reset {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .section-title {
                font-size: 16px;
            }

            .section-connection {
                font-size: 13px;
            }

            .tree-node {
                font-size: 14px;
            }

            .pie-chart-wrapper {
                padding: 15px;
            }

            .pie-chart-wrapper canvas {
                min-height: 300px;
            }
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }

        .section-title {
            color: var(--color-primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::after {
            content: "";
            flex: 1;
            height: 2px;
            background: linear-gradient(to right, var(--color-primary), transparent);
        }

        .section-connection {
            font-size: 14px;
            color: #666;
            margin-top: -15px;
            margin-bottom: 15px;
            padding-left: 20px;
            border-left: 3px solid var(--color-tertiary);
        }

        /* æ ‘å½¢å›¾æ ·å¼ */
        .tree-node {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .tree-content {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tree-children {
            margin-left: 35px;
            display: none;
            border-left: 2px solid #e0e0e0;
            padding-left: 15px;
        }

        .expanded > .tree-children {
            display: block;
        }

        .toggle-btn {
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            background-color: transparent;
            color: black;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            border: 2px solid #333;
        }

        .node-text {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .node-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .level-1 { background-color: var(--color-primary); color: white; }
        .level-2 { background-color: var(--color-secondary); color: white; }
        .level-3 { background-color: var(--color-tertiary); color: white; }
        .level-4 { background-color: var(--color-quaternary); color: white; }
        .level-5 { background-color: var(--color-quinary); color: white; }
        .level-6 { background-color: var(--color-senary); color: white; }
        .level-7 { background-color: var(--color-septenary); color: white; }
        .level-8 { background-color: var(--color-octonary); color: white; }

        /* ç€‘å¸ƒå›¾æ ·å¼ */
        .waterfall-chart {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }

        /* æ”¹å–„ä¸¾æªå¡ç‰‡æ ·å¼ */
        .improvement-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .card-header:hover {
            background-color: #f8f9fa;
        }

        .card-header.active {
            border-left-color: var(--color-primary);
            background-color: #f0f0f0;
        }

        .card-header i {
            width: 24px;
            text-align: center;
        }

        .card-content {
            display: none;
            padding: 0 15px;
            background-color: #fff;
        }

        .card-content.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sub-improvement {
            margin: 15px 0;
            padding-left: 34px;
        }

        .improvement-details {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .improvement-details h4 {
            margin: 0 0 10px 0;
            color: var(--color-primary);
        }

        .improvement-list {
            margin: 0;
            padding-left: 20px;
        }

        .effect-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: var(--color-tertiary);
            color: white;
            font-size: 0.9em;
            margin-top: 8px;
        }

        .level-title {
            font-weight: bold;
            color: var(--color-primary);
        }

        .reference-link {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 12px;
            color: var(--color-tertiary);
            text-decoration: none;
        }

        .reference-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-main">è·³è‡³ä¸»è¦å†…å®¹</a>
    <header class="header" role="banner">
        <h1>ENNOVI PNL åˆ†ææŒ‡å¯¼æ‰‹å†Œ</h1>
    </header>

    <main id="main-content" class="container" role="main">
        <!-- æ¨¡å—1ï¼šPNLè´¢åŠ¡ç»“æ„åˆ†è§£ -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-sitemap"></i>
                æ¨¡å—1ï¼šPNLè´¢åŠ¡ç»“æ„åˆ†è§£
            </h2>
            <p class="section-connection">
                æ­¤æ¨¡å—å±•ç¤ºäº†å®Œæ•´çš„è´¢åŠ¡æŒ‡æ ‡ä½“ç³»ï¼Œä¸ºæ¨¡å—2çš„æ•°æ®æµåŠ¨å’Œæ¨¡å—3çš„æ”¹å–„ä¸¾æªæä¾›åŸºç¡€æ¡†æ¶
            </p>
            <div id="tree-container" role="tree" aria-label="è´¢åŠ¡æŒ‡æ ‡ç»“æ„æ ‘"></div>
        </div>

        <!-- æ¨¡å—2ï¼šPNLç€‘å¸ƒå›¾è¯´æ˜ -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-bar"></i>
                æ¨¡å—2ï¼šPNLç€‘å¸ƒå›¾è¯´æ˜
            </h2>
            <p class="section-connection">
                åŸºäºæ¨¡å—1çš„ç»“æ„ï¼Œå±•ç¤ºå…³é”®è´¢åŠ¡æŒ‡æ ‡é—´çš„é‡åŒ–å…³ç³»ï¼Œå¹¶ä¸æ¨¡å—3çš„æ”¹å–„ä¸¾æªç›´æ¥å¯¹åº”
            </p>
            <canvas id="waterfallChart" class="waterfall-chart"></canvas>
            <a href="#improvement-container" class="reference-link">æŸ¥çœ‹ç›¸å…³æ”¹å–„ä¸¾æª â†’</a>
        </div>

        <!-- æ¨¡å—3ï¼šæ”¹å–„å„ä¸ªå±‚çº§çš„å…³é”®ä¸¾æª -->
        <div class="section">
            <h2 class="section-title">
                <i class="fas fa-tasks"></i>
                æ¨¡å—3ï¼šæ”¹å–„å„ä¸ªå±‚çº§çš„å…³é”®ä¸¾æª
            </h2>
            <p class="section-connection">
                é’ˆå¯¹æ¨¡å—1çš„ç»“æ„å’Œæ¨¡å—2çš„æ•°æ®è¡¨ç°ï¼Œæä¾›å…·ä½“çš„æ”¹å–„æ–¹æ¡ˆå’Œé¢„æœŸæ•ˆæœ
            </p>
            <div id="improvement-container" role="tablist" aria-label="æ”¹å–„ä¸¾æªåˆ—è¡¨">
                <!-- æ”¶å…¥æ”¹å–„ -->
                <div class="improvement-card">
                    <div class="card-header" onclick="toggleCard(this)" onkeydown="handleTabKeydown(event)" role="tab" tabindex="0" aria-expanded="false">
                        <i class="fas fa-dollar-sign"></i>
                        <span class="level-title">æ”¶å…¥æ”¹å–„</span>
                    </div>
                    <div class="card-content" role="tabpanel" aria-hidden="true">
                        <div class="improvement-details">
                            <h4>æ€»ä½“ç­–ç•¥</h4>
                            <ul class="improvement-list">
                                <li>å¼€å‘æ–°å¸‚åœºå’Œå®¢æˆ·ç¾¤</li>
                                <li>ä¼˜åŒ–äº§å“ç»„åˆç»“æ„</li>
                                <li>å®æ–½åŠ¨æ€å®šä»·ç­–ç•¥</li>
                            </ul>
                            <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡é”€å”®æ”¶å…¥10-15%</div>
                        </div>
                        <div class="sub-improvement">
                            <h4>æ¨¡å…·æ”¶å…¥ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>æå‡æ¨¡å…·è®¾è®¡èƒ½åŠ›</li>
                                    <li>ä¼˜åŒ–æ¨¡å…·åˆ¶é€ å·¥è‰º</li>
                                    <li>åŠ å¼ºæ¨¡å…·ç»´æŠ¤ç®¡ç†</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡æ¨¡å…·æ”¶å…¥8-12%</div>
                            </div>
                            <h4>å¤–éƒ¨é›¶ä»¶æ”¶å…¥ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>æ‰©å¤§å¸‚åœºä»½é¢</li>
                                    <li>å¼€å‘é«˜é™„åŠ å€¼äº§å“</li>
                                    <li>ä¼˜åŒ–å®¢æˆ·ç»“æ„</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡é›¶ä»¶æ”¶å…¥12-15%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GMMæ”¹å–„ -->
                <div class="improvement-card">
                    <div class="card-header" onclick="toggleCard(this)" onkeydown="handleTabKeydown(event)" role="tab" tabindex="0" aria-expanded="false">
                        <i class="fas fa-percentage"></i>
                        <span class="level-title">GMMæ”¹å–„</span>
                    </div>
                    <div class="card-content">
                        <div class="improvement-details">
                            <h4>å…³é”®ä¸¾æª</h4>
                            <ul class="improvement-list">
                                <li>ä¼˜åŒ–äº§å“ç»“æ„</li>
                                <li>æå‡ç”Ÿäº§æ•ˆç‡</li>
                                <li>é™ä½ææ–™æˆæœ¬</li>
                            </ul>
                            <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡æ¯›åˆ©ç‡2-3%</div>
                        </div>
                        <div class="sub-improvement">
                            <h4>ç›´æ¥ææ–™æˆæœ¬ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>ä¾›åº”å•†æ•´åˆä¸è°ˆåˆ¤</li>
                                    <li>ææ–™æ›¿ä»£ä¼˜åŒ–</li>
                                    <li>åº“å­˜ç®¡ç†ä¼˜åŒ–</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½ææ–™æˆæœ¬5-8%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COPAæ”¹å–„ -->
                <div class="improvement-card">
                    <div class="card-header" onclick="toggleCard(this)" onkeydown="handleTabKeydown(event)" role="tab" tabindex="0" aria-expanded="false">
                        <i class="fas fa-industry"></i>
                        <span class="level-title">COPAæ”¹å–„</span>
                    </div>
                    <div class="card-content" role="tabpanel">
                        <div class="improvement-details">
                            <h4>æ€»ä½“ç­–ç•¥</h4>
                            <ul class="improvement-list">
                                <li>ä¼˜åŒ–å¤–åŒ…ç®¡ç†</li>
                                <li>æå‡åŒ…è£…æ•ˆç‡</li>
                                <li>é™ä½å¤–åŒ…æˆæœ¬</li>
                            </ul>
                            <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½COPAæˆæœ¬5-7%</div>
                        </div>
                        <div class="sub-improvement">
                            <h4>å¤–åŒ…æˆæœ¬ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>ä¾›åº”å•†è¯„ä¼°ä¼˜åŒ–</li>
                                    <li>å¤–åŒ…æµç¨‹æ ‡å‡†åŒ–</li>
                                    <li>å¤–åŒ…è´¨é‡æ§åˆ¶</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½å¤–åŒ…æˆæœ¬5-8%</div>
                            </div>
                            <h4>åŒ…è£…æˆæœ¬ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>åŒ…è£…è®¾è®¡ä¼˜åŒ–</li>
                                    <li>åŒ…è£…ææ–™ä¼˜åŒ–</li>
                                    <li>åŒ…è£…æµç¨‹æ”¹å–„</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½åŒ…è£…æˆæœ¬3-5%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GPæ”¹å–„ -->
                <div class="improvement-card">
                    <div class="card-header" onclick="toggleCard(this)" onkeydown="handleTabKeydown(event)" role="tab" tabindex="0" aria-expanded="false">
                        <i class="fas fa-chart-line"></i>
                        <span class="level-title">GPæ”¹å–„</span>
                    </div>
                    <div class="card-content" role="tabpanel">
                        <div class="improvement-details">
                            <h4>æ€»ä½“ç­–ç•¥</h4>
                            <ul class="improvement-list">
                                <li>æå‡äººå·¥æ•ˆç‡</li>
                                <li>ä¼˜åŒ–é—´æ¥æˆæœ¬</li>
                                <li>ç²¾ç®€ç»„ç»‡ç»“æ„</li>
                            </ul>
                            <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡æ¯›åˆ©3-5%</div>
                        </div>
                        <div class="sub-improvement">
                            <h4>äººå·¥æ•ˆç‡æå‡</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>ç”Ÿäº§æ•ˆç‡æå‡</li>
                                    <li>å·¥è‰ºä¼˜åŒ–æ”¹å–„</li>
                                    <li>è‡ªåŠ¨åŒ–æ¨è¿›</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæé«˜äººæ•ˆ15-20%</div>
                            </div>
                            <h4>é—´æ¥è´¹ç”¨ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>èƒ½æºç®¡ç†ä¼˜åŒ–</li>
                                    <li>è®¾å¤‡ç»´æŠ¤ä¼˜åŒ–</li>
                                    <li>äº§èƒ½åˆ©ç”¨æå‡</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½é—´æ¥æˆæœ¬12-15%</div>
                            </div>
                            <h4>IDLä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>æµç¨‹å†é€ </li>
                                    <li>ç»„ç»‡æ‰å¹³åŒ–</li>
                                    <li>æ•°å­—åŒ–åŠå…¬</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½IDLæˆæœ¬8-10%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EBITDAæ”¹å–„ -->
                <div class="improvement-card">
                    <div class="card-header" onclick="toggleCard(this)" onkeydown="handleTabKeydown(event)" role="tab" tabindex="0" aria-expanded="false">
                        <i class="fas fa-chart-line"></i>
                        <span class="level-title">EBITDAæ”¹å–„</span>
                    </div>
                    <div class="card-content" role="tabpanel">
                        <div class="improvement-details">
                            <h4>æ€»ä½“ç­–ç•¥</h4>
                            <ul class="improvement-list">
                                <li>ä¼˜åŒ–èµ„äº§ç»“æ„</li>
                                <li>æå‡è¿è¥æ•ˆç‡</li>
                                <li>åŠ å¼ºæˆæœ¬ç®¡æ§</li>
                            </ul>
                            <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡EBITDA 5-8%</div>
                        </div>
                        <div class="sub-improvement">
                            <h4>è¿è¥è´¹ç”¨ä¼˜åŒ–</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>ç²¾ç®€ç®¡ç†å±‚çº§</li>
                                    <li>ä¼˜åŒ–ä¸šåŠ¡æµç¨‹</li>
                                    <li>æ¨è¿›æ•°å­—åŒ–è½¬å‹</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šé™ä½è¿è¥è´¹ç”¨10-12%</div>
                            </div>
                            <h4>èµ„äº§æ•ˆç‡æå‡</h4>
                            <div class="improvement-details">
                                <ul class="improvement-list">
                                    <li>ä¼˜åŒ–èµ„äº§é…ç½®</li>
                                    <li>æé«˜èµ„äº§å‘¨è½¬</li>
                                    <li>åŠ å¼ºèµ„äº§ç®¡ç†</li>
                                </ul>
                                <div class="effect-badge">é¢„æœŸæ•ˆæœï¼šæå‡èµ„äº§æ”¶ç›Š3-5%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer role="contentinfo" class="footer">
        <p class="footer-text">Â© 2025 ENNOVI. PNLåˆ†æå·¥å…· v1.0</p>
    </footer>

    <style>
        .footer {
            background: var(--color-primary);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }

        .footer-text {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        @media print {
            .footer {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .footer {
                padding: 15px;
                font-size: 12px;
            }
        }
    </style>

    <script>
        // ç¬¬ä¸€æ¨¡å—ï¼šæ ‘å½¢ç»“æ„ä»£ç 
        function getNodeLevel(node, level = 1) {
            node.level = level;
            if (node.children) {
                node.children.forEach(child => getNodeLevel(child, level + 1));
            }
            return node;
        }

        const operatingIncome = {
            text: "è¥ä¸šåˆ©æ¶¦ (Operating Income)",
            children: [{
                text: "åˆå¹¶EBITDA (EBITDA Before Corp Charge)",
                children: [
                    { text: "æ‘Šé”€ (Amortization)" },
                    { text: "æŠ˜æ—§ (Depreciation)" }
                ]
            }]
        };

        const grossProfit = {
            text: "æ¯›åˆ© (Gross Profit)",
            children: [
                { text: "è¥ä¸šè´¹ç”¨ (Operating Expenses)" },
                { text: "é”€å”®ä¸å¸‚åœºè´¹ç”¨ (Sales & Marketing)" },
                { text: "è¡Œæ”¿ç®¡ç†è´¹ç”¨ (General & Administration)" },
                { text: "ç ”å‘è´¹ç”¨ (Research & Development)" },
                operatingIncome
            ]
        };

        const treeData = getNodeLevel({
            text: "æ€»æ”¶å…¥ (Total Revenue)",
            children: [
                { text: "æ¨¡å…·æ”¶å…¥ (Tooling Revenue)" },
                {
                    text: "æ€»æ”¶å…¥ï¼ˆä¸å«æ¨¡å…·ï¼‰ (Total Revenue (Ex Tooling))",
                    children: [
                        {
                            text: "å¤–éƒ¨é›¶ä»¶æ”¶å…¥ (External Parts Revenue)",
                            children: [
                                {
                                    text: "é”€å”®æˆæœ¬ (COS)",
                                    children: [
                                        { text: "ç›´æ¥ææ–™æˆæœ¬ (Direct Material Costs)" },
                                        { text: "å…¶ä»–COSæˆæœ¬ (Other COS Costs)" }
                                    ]
                                },
                                {
                                    text: "æ€»è¾¹é™…è´¡çŒ® (GMM)",
                                    children: [
                                        { text: "åŒ…è£…æˆæœ¬ (Packaging Costs)" },
                                        { text: "å¤–åŒ…æˆæœ¬ (Subcontracting Costs)" },
                                        {
                                            text: "COPA",
                                            children: [
                                                {
                                                    text: "ç›´æ¥äººå·¥ (Direct Labor)",
                                                    children: [
                                                        { text: "ç”Ÿäº§å·¥äººå·¥èµ„ (Production Workers Salary)" },
                                                        { text: "åŠ ç­è´¹ (Overtime Pay)" },
                                                        { text: "å¥–é‡‘ä¸æ´¥è´´ (Bonuses & Allowances)" },
                                                        { text: "ç¤¾ä¼šä¿é™©è´¹ (Social Insurance)" }
                                                    ]
                                                },
                                                { text: "é—´æ¥äººå·¥ (Indirect Labor)" },
                                                {
                                                    text: "é—´æ¥æˆæœ¬ (Indirect Costs)",
                                                    children: [
                                                        {
                                                            text: "æ ‡å‡†é—´æ¥æˆæœ¬ (Standard Indirect COS)",
                                                            children: [
                                                                { text: "è®¾å¤‡æŠ˜æ—§ (Equipment Depreciation)" },
                                                                { text: "å‚æˆ¿ç§Ÿé‡‘ (Plant Rent)" },
                                                                { text: "æ°´ç”µè´¹ (Utilities)" },
                                                                { text: "ç»´ä¿®ä¿å…» (Maintenance)" }
                                                            ]
                                                        },
                                                        {
                                                            text: "éæ ‡å‡†é—´æ¥æˆæœ¬ (Non-Standard Indirect COS)",
                                                            children: [
                                                                { text: "ç‰©æ–™æŸè€— (Material Wastage)" },
                                                                { text: "ç‰¹æ®Šå·¥å…·è´¹ç”¨ (Special Tool Costs)" },
                                                                { text: "è´¨é‡æˆæœ¬ (Quality Costs)" },
                                                                { text: "å…¶ä»–é—´æ¥è´¹ç”¨ (Other Indirect Expenses)" }
                                                            ]
                                                        }
                                                    ]
                                                },
                                                grossProfit
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        { text: "å…³è”äº¤æ˜“æ”¶å…¥ (Intercompany Revenue)" }
                    ]
                }
            ]
        });

        function getIconForNode(text) {
            if (text.includes('æ”¶å…¥')) return 'fas fa-dollar-sign';
            if (text.includes('æˆæœ¬')) return 'fas fa-coins';
            if (text.includes('åˆ©æ¶¦')) return 'fas fa-chart-line';
            if (text.includes('è´¹ç”¨')) return 'fas fa-file-invoice-dollar';
            if (text.includes('äººå·¥')) return 'fas fa-users';
            if (text.includes('ææ–™')) return 'fas fa-boxes';
            if (text.includes('æŠ˜æ—§') || text.includes('æ‘Šé”€')) return 'fas fa-chart-area';
            if (text.includes('ç¨')) return 'fas fa-percentage';
            return 'fas fa-circle';
        }

        function createTreeNode(data) {
            const nodeDiv = document.createElement('div');
            nodeDiv.className = `tree-node level-${Math.min(data.level, 8)}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'tree-content';

            const toggleBtn = document.createElement('span');
            toggleBtn.className = 'toggle-btn';
            toggleBtn.textContent = '+';

            const textSpan = document.createElement('span');
            textSpan.className = 'node-text';
            const icon = document.createElement('i');
            icon.className = getIconForNode(data.text) + ' node-icon';
            textSpan.appendChild(icon);
            
            const textContent = document.createElement('span');
            textContent.textContent = data.text;
            textSpan.appendChild(textContent);

            contentDiv.appendChild(toggleBtn);
            contentDiv.appendChild(textSpan);
            nodeDiv.appendChild(contentDiv);

            if (data.children && data.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'tree-children';
                data.children.forEach(child => {
                    childrenDiv.appendChild(createTreeNode(child));
                });
                nodeDiv.appendChild(childrenDiv);

                contentDiv.addEventListener('click', () => {
                    nodeDiv.classList.toggle('expanded');
                    toggleBtn.textContent = nodeDiv.classList.contains('expanded') ? '-' : '+';
                });
            }

            return nodeDiv;
        }

        // ç¬¬äºŒæ¨¡å—ï¼šç€‘å¸ƒå›¾
        const waterfallData = {
            labels: [
                'æ€»æ”¶å…¥ (Revenue)',
                'ç›´æ¥ææ–™æˆæœ¬ (Direct Material)',
                'æ€»è¾¹é™…è´¡çŒ® (GMM)',
                'åŒ…è£…æˆæœ¬ (Packaging)',
                'å¤–åŒ…æˆæœ¬ (Subcontracting)',
                'COPA',
                'ç›´æ¥äººå·¥ (Direct Labor)',
                'é—´æ¥äººå·¥ (Indirect Labor)',
                'é—´æ¥æˆæœ¬ (Indirect Costs)',
                'æ¯›åˆ© (GP)',
                'è¥ä¸šè´¹ç”¨ (Operating Exp)',
                'é”€å”®è´¹ç”¨ (S&M)',
                'ç®¡ç†è´¹ç”¨ (G&A)',
                'ç ”å‘è´¹ç”¨ (R&D)',
                'è¥ä¸šåˆ©æ¶¦ (Operating Income)',
                'åˆå¹¶EBITDA'
            ],
            datasets: [{
                data: [1000, -450, 550, -50, -50, 450, -80, -40, -80, 250, -40, -30, -35, -45, 100, 80],
                backgroundColor: [
                    'rgba(15, 15, 109, 0.8)',    // æ·±è“ - æ”¶å…¥
                    'rgba(161, 0, 255, 0.8)',    // ç´«è‰² - ææ–™æˆæœ¬
                    'rgba(0, 181, 247, 0.8)',    // æµ…è“ - GMM
                    'rgba(255, 79, 143, 0.8)',   // ç²‰è‰² - Packaging
                    'rgba(123, 97, 255, 0.8)',   // ç´«ç½—å…° - Subcontracting
                    'rgba(0, 217, 197, 0.8)',    // é’è‰² - COPA
                    'rgba(255, 184, 0, 0.8)',    // é‡‘è‰² - Direct Labor
                    'rgba(28, 163, 125, 0.8)',   // ç»¿è‰² - Indirect Labor
                    'rgba(15, 15, 109, 0.8)',    // æ·±è“ - Indirect Costs
                    'rgba(161, 0, 255, 0.8)',    // ç´«è‰² - GP
                    'rgba(0, 181, 247, 0.8)',    // æµ…è“ - Operating Exp
                    'rgba(255, 79, 143, 0.8)',   // ç²‰è‰² - S&M
                    'rgba(123, 97, 255, 0.8)',   // ç´«ç½—å…° - G&A
                    'rgba(0, 217, 197, 0.8)',    // é’è‰² - R&D
                    'rgba(255, 184, 0, 0.8)',    // é‡‘è‰² - Operating Income
                    'rgba(28, 163, 125, 0.8)'    // ç»¿è‰² - EBITDA
                ],
                borderColor: Array(16).fill('rgba(255, 255, 255, 1)'),
                borderWidth: 1
            }]
        };

        const waterfallCtx = document.getElementById('waterfallChart').getContext('2d');
        new Chart(waterfallCtx, {
            type: 'bar',
            data: waterfallData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'é‡‘é¢ (ç™¾ä¸‡å…ƒ)'
                        },
                        grid: {
                            drawBorder: true,
                            color: function(context) {
                                if (context.tick.value === 550) return 'rgba(0, 181, 247, 0.5)';  // GMM
                                if (context.tick.value === 450) return 'rgba(0, 217, 197, 0.5)';  // COPA
                                if (context.tick.value === 250) return 'rgba(161, 0, 255, 0.5)';  // GP
                                if (context.tick.value === 100) return 'rgba(255, 184, 0, 0.5)';  // Operating Income
                                if (context.tick.value === 80) return 'rgba(28, 163, 125, 0.5)';  // EBITDA
                                return 'rgba(0, 0, 0, 0.1)';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: '2024è´¢å¹´PNLç€‘å¸ƒå›¾åˆ†æ',
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });

        // ç¬¬ä¸‰æ¨¡å—ï¼šæ”¹å–„ä¸¾æªå¡ç‰‡äº¤äº’
        function toggleCard(header) {
            const content = header.nextElementSibling;
            const isExpanding = !content.classList.contains('active');
            
            // å…³é—­å…¶ä»–å±•å¼€çš„å¡ç‰‡
            document.querySelectorAll('.card-content.active').forEach(activeContent => {
                if (activeContent !== content) {
                    activeContent.classList.remove('active');
                    activeContent.previousElementSibling.classList.remove('active');
                    // Update ARIA states
                    activeContent.setAttribute('aria-hidden', 'true');
                    activeContent.previousElementSibling.setAttribute('aria-expanded', 'false');
                }
            });
            
            // åˆ‡æ¢å½“å‰å¡ç‰‡
            content.classList.toggle('active');
            header.classList.toggle('active');
            
            // Update ARIA states
            content.setAttribute('aria-hidden', !isExpanding);
            header.setAttribute('aria-expanded', isExpanding);
            
            // å¦‚æœæ˜¯å±•å¼€æ“ä½œï¼Œæ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
            if (isExpanding) {
                header.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                // Set focus to the header for better keyboard navigation
                header.focus();
            }
        }

        // Keyboard navigation handler for tabs
        function handleTabKeydown(event) {
            const header = event.target;
            const tablist = header.closest('[role="tablist"]');
            const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
            const currentIndex = tabs.indexOf(header);

            let nextTab;
            switch (event.key) {
                case 'ArrowDown':
                case 'ArrowRight':
                    event.preventDefault();
                    nextTab = tabs[currentIndex + 1] || tabs[0];
                    break;
                case 'ArrowUp':
                case 'ArrowLeft':
                    event.preventDefault();
                    nextTab = tabs[currentIndex - 1] || tabs[tabs.length - 1];
                    break;
                case 'Home':
                    event.preventDefault();
                    nextTab = tabs[0];
                    break;
                case 'End':
                    event.preventDefault();
                    nextTab = tabs[tabs.length - 1];
                    break;
                case 'Enter':
                case ' ':
                    event.preventDefault();
                    toggleCard(header);
                    return;
            }

            if (nextTab) {
                nextTab.focus();
            }
        }

        // ç¬¬å››æ¨¡å—ï¼šæ”¹å–„æ¨¡æ‹Ÿ
        const simulationData = {
            labels: waterfallData.labels,
            baseValues: waterfallData.datasets[0].data,
            maxPercentages: [20, 8, 5, 5, 5, 10, 15, 10, 12, 8, 10, 8, 8, 10, 8, 5],
            colors: waterfallData.datasets[0].backgroundColor
        };

            function createSimulationTable() {
                const container = document.createElement('div');
                container.className = 'simulation-table-container';

                // æ·»åŠ æ‰¹é‡è°ƒæ•´æ§åˆ¶
                const batchControl = document.createElement('div');
                batchControl.className = 'batch-control';
                
                const batchHeader = document.createElement('div');
                batchHeader.className = 'batch-header';
                
                const batchIcon = document.createElement('i');
                batchIcon.className = 'fas fa-percentage';
                
                const batchLabel = document.createElement('label');
                batchLabel.textContent = 'æ‰¹é‡è°ƒæ•´';
                
                const batchHelp = document.createElement('div');
                batchHelp.className = 'batch-help';
                batchHelp.innerHTML = 'æ‰¹é‡æ›´æ–°æ‰€æœ‰å¯è°ƒæ•´é¡¹çš„æ”¹å–„ç™¾åˆ†æ¯”ï¼Œä»¥å¿«é€Ÿæ¨¡æ‹Ÿæ•´ä½“æ”¹å–„æ•ˆæœ';
                
                batchHeader.appendChild(batchIcon);
                batchHeader.appendChild(batchLabel);
                batchHeader.appendChild(batchHelp);
                
                const batchInput = document.createElement('input');
                batchInput.type = 'number';
                batchInput.min = '0';
                batchInput.step = '0.1';
                batchInput.className = 'batch-input';
                batchInput.placeholder = 'è¾“å…¥æ”¹å–„ç™¾åˆ†æ¯” (0-20%)';
                batchInput.title = 'å»ºè®®è¾“å…¥0-20%ä¹‹é—´çš„å€¼';
                
                // æ·»åŠ è¾“å…¥éªŒè¯
                batchInput.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    if (isNaN(value)) {
                        e.target.setCustomValidity('');
                    } else if (value < 0) {
                        e.target.setCustomValidity('æ”¹å–„ç™¾åˆ†æ¯”ä¸èƒ½ä¸ºè´Ÿæ•°');
                    } else if (value > 20) {
                        e.target.setCustomValidity('å»ºè®®æ”¹å–„ç™¾åˆ†æ¯”ä¸è¶…è¿‡20%');
                    } else {
                        e.target.setCustomValidity('');
                    }
                    e.target.reportValidity();
                });
                
                const batchButton = document.createElement('button');
                batchButton.innerHTML = '<i class="fas fa-magic"></i> åº”ç”¨åˆ°æ‰€æœ‰å¯è°ƒæ•´é¡¹';
                batchButton.className = 'batch-apply';
                batchButton.title = 'ç‚¹å‡»å°†åº”ç”¨å½“å‰ç™¾åˆ†æ¯”åˆ°æ‰€æœ‰å¯è°ƒæ•´çš„æŒ‡æ ‡';
                batchButton.onclick = () => {
                    const value = parseFloat(batchInput.value);
                    if (!isNaN(value) && value >= 0 && value <= 20) {
                        document.querySelectorAll('.simulation-table input[type="number"]').forEach(input => {
                            input.value = value;
                            input.dispatchEvent(new Event('input'));
                        });
                        // æ·»åŠ åº”ç”¨æˆåŠŸçš„è§†è§‰åé¦ˆ
                        batchButton.classList.add('success');
                        setTimeout(() => batchButton.classList.remove('success'), 1000);
                    } else {
                        batchInput.reportValidity();
                    }
                };
                
                // Create title group
                const batchTitle = document.createElement('div');
                batchTitle.className = 'batch-title';
                batchTitle.appendChild(batchIcon);
                batchTitle.appendChild(batchLabel);
                
                const batchContent = document.createElement('div');
                batchContent.className = 'batch-content';
                batchContent.appendChild(batchTitle);
                batchContent.appendChild(batchHelp);

                // Create input wrapper
                const batchInputWrapper = document.createElement('div');
                batchInputWrapper.className = 'batch-input-wrapper';
                batchInputWrapper.appendChild(batchInput);

                // Add all elements to control container
                batchControl.appendChild(batchContent);
                batchControl.appendChild(batchInputWrapper);
                batchControl.appendChild(batchButton);
                container.appendChild(batchControl);
                
                const table = document.createElement('table');
                table.className = 'simulation-table';

                // æ·»åŠ æ‰¹é‡è°ƒæ•´æ§åˆ¶æ ·å¼
                const batchStyle = document.createElement('style');
                batchStyle.textContent = `
                    .batch-control {
                        margin-bottom: 20px;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border: 2px solid #eee;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }

                    @media (min-width: 768px) {
                        .batch-control {
                            flex-direction: row;
                            align-items: center;
                            justify-content: space-between;
                        }

                        .batch-content {
                            flex: 2;
                        }

                        .batch-input-wrapper,
                        .batch-apply {
                            flex: 1;
                        }
                    }

                    .batch-header {
                        display: flex;
                        flex-wrap: wrap;
                        align-items: center;
                        gap: 12px;
                        padding-bottom: 15px;
                        border-bottom: 1px solid #eee;
                    }

                    @media (min-width: 768px) {
                        .batch-header {
                            padding-bottom: 0;
                            border-bottom: none;
                            margin-bottom: 0;
                        }
                    }

                    .batch-title {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        min-width: 120px;
                    }

                    .batch-help {
                        position: relative;
                        padding: 8px 12px 8px 32px;
                        font-size: 14px;
                        color: #666;
                        line-height: 1.5;
                        flex: 1;
                        background: rgba(0, 181, 247, 0.05);
                        border-radius: 6px;
                        border-left: 3px solid var(--color-tertiary);
                    }

                    .batch-help::before {
                        content: "ğŸ’¡";
                        position: absolute;
                        left: 8px;
                        top: 50%;
                        transform: translateY(-50%);
                        font-size: 16px;
                    }

                    @media (max-width: 767px) {
                        .batch-help {
                            margin: 8px 0;
                            padding: 12px 12px 12px 36px;
                        }
                    }

                    .batch-input-wrapper {
                        position: relative;
                        width: 100%;
                    }

                    @media (min-width: 768px) {
                        .batch-input-wrapper {
                            width: auto;
                        }
                    }

                    .batch-input {
                        width: 100%;
                        max-width: 180px;
                    }

                    .batch-apply {
                        width: 100%;
                        justify-content: center;
                    }

                    @media (min-width: 768px) {
                        .batch-apply {
                            width: auto;
                        }
                    }

                    .batch-header i {
                        font-size: 20px;
                        color: var(--color-primary);
                    }

                    .batch-header label {
                        font-size: 16px;
                        font-weight: bold;
                        color: var(--color-primary);
                    }

                    .batch-help {
                        font-size: 14px;
                        color: #666;
                        margin-left: auto;
                        max-width: 300px;
                        line-height: 1.4;
                    }

                    .batch-input {
                        padding: 12px 15px;
                        border: 2px solid #e0e0e0;
                        border-radius: 8px;
                        width: 180px;
                        font-family: 'Consolas', monospace;
                        font-size: 14px;
                        color: #333;
                        background: white;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    }

                    .batch-input:hover {
                        border-color: var(--color-tertiary);
                    }

                    .batch-input:focus {
                        outline: none;
                        border-color: var(--color-tertiary);
                        box-shadow: 0 0 0 3px rgba(0, 181, 247, 0.1);
                    }

                    .batch-input:invalid {
                        border-color: #F44336;
                        background-color: rgba(244, 67, 54, 0.03);
                        box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
                    }

                    .batch-input::placeholder {
                        color: #999;
                        font-style: italic;
                    }

                    .batch-apply {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: bold;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 10px;
                        transition: all 0.3s ease;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .batch-apply i {
                        font-size: 16px;
                        transition: transform 0.3s ease;
                    }

                    .batch-apply:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    }

                    .batch-apply:hover i {
                        transform: rotate(180deg);
                    }

                    .batch-apply:active {
                        transform: translateY(0);
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    }

                    .batch-apply.success {
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                        animation: success-pulse 1s ease;
                    }

                    .batch-apply:disabled {
                        background: #e0e0e0;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                    }

                    @keyframes success-pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.05); }
                        100% { transform: scale(1); }
                    }
                `;
                document.head.appendChild(batchStyle);

            // è¡¨å¤´
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['æŒ‡æ ‡', 'åŸå§‹æ•°å€¼', 'æ”¹å–„ç™¾åˆ†æ¯”', 'æ¨¡æ‹Ÿç»“æœ'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // è¡¨ä½“
            const tbody = document.createElement('tbody');
            simulationData.labels.forEach((label, index) => {
                const tr = document.createElement('tr');
                
                // æŒ‡æ ‡åç§°
                const labelCell = document.createElement('td');
                labelCell.textContent = label;
                tr.appendChild(labelCell);

                // åŸå§‹æ•°å€¼
                const baseValueCell = document.createElement('td');
                baseValueCell.textContent = simulationData.baseValues[index];
                baseValueCell.className = 'base-value';
                tr.appendChild(baseValueCell);

                // æ”¹å–„ç™¾åˆ†æ¯”è¾“å…¥æˆ–æ˜¾ç¤º
                const inputCell = document.createElement('td');
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'input-wrapper';

                // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸å¯è¾“å…¥çš„æŒ‡æ ‡
                const nonEditableItems = ['GMM', 'COPA', 'GP', 'è¥ä¸šåˆ©æ¶¦', 'EBITDA'];
                const isNonEditable = nonEditableItems.some(item => label.includes(item));

                if (isNonEditable) {
                    // å¯¹äºä¸å¯ç¼–è¾‘é¡¹ï¼Œåˆ›å»ºæ˜¾ç¤ºç™¾åˆ†æ¯”çš„span
                    const percentageSpan = document.createElement('span');
                    percentageSpan.className = 'percentage-display';
                    percentageSpan.textContent = '0.00%';
                    inputWrapper.appendChild(percentageSpan);
                } else {
                    // å¯¹äºå¯ç¼–è¾‘é¡¹ï¼Œåˆ›å»ºè¾“å…¥æ¡†
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.min = '0';
                    input.step = '0.1';
                    input.placeholder = `å»ºè®®ä¸è¶…è¿‡ ${simulationData.maxPercentages[index]}%`;
                    input.dataset.index = index;
                    input.style.color = '#666';
                    input.addEventListener('input', updateSimulationResults);
                    inputWrapper.appendChild(input);
                }
                inputCell.appendChild(inputWrapper);
                tr.appendChild(inputCell);

                // æ¨¡æ‹Ÿç»“æœ
                const resultCell = document.createElement('td');
                resultCell.className = 'simulation-result';
                resultCell.textContent = simulationData.baseValues[index];
                tr.appendChild(resultCell);

                // è®¾ç½®æ­£æ•°å€¼è¡Œçš„ç‰¹æ®Šæ ·å¼
                if (simulationData.baseValues[index] > 0) {
                    tr.classList.add('positive-value');
                }
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            container.appendChild(table);

            // æ·»åŠ æ•°æ®å¯¹æ¯”è¡¨æ ¼åŒºåŸŸ
            const dataComparisonDiv = document.createElement('div');
            dataComparisonDiv.className = 'data-comparison-section';
            
            const comparisonTableTitle = document.createElement('h3');
            comparisonTableTitle.textContent = 'æ•°æ®å¯¹æ¯”åˆ†æ';
            comparisonTableTitle.className = 'comparison-title';
            dataComparisonDiv.appendChild(comparisonTableTitle);

            const comparisonTable = document.createElement('table');
            comparisonTable.className = 'comparison-table';
            comparisonTable.innerHTML = `
                <thead>
                    <tr>
                        <th>æŒ‡æ ‡</th>
                        <th>æ”¹å–„å‰æ•°å€¼</th>
                        <th>æ”¹å–„å‰å æ¯”</th>
                        <th>æ”¹å–„åæ•°å€¼</th>
                        <th>æ”¹å–„åå æ¯”</th>
                        <th>å˜åŒ–å¹…åº¦</th>
                    </tr>
                </thead>
                <tbody>
                    ${simulationData.labels.filter((_, i) => simulationData.baseValues[i] > 0)
                        .map((label, i) => {
                            const value = simulationData.baseValues[i];
                            const total = simulationData.baseValues
                                .filter(v => v > 0)
                                .reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `
                                <tr>
                                    <td>${label}</td>
                                    <td class="value">${value}</td>
                                    <td class="percentage">${percentage}%</td>
                                    <td class="value">-</td>
                                    <td class="percentage">-</td>
                                    <td class="percentage">-</td>
                                </tr>
                            `;
                        }).join('')}
                </tbody>
            `;

            // æ·»åŠ æŒ‰é’®
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';
            
            const submitButton = document.createElement('button');
            submitButton.className = 'simulation-submit';
            submitButton.onclick = updateCharts;
            submitButton.innerHTML = '<i class="fas fa-chart-pie"></i> æäº¤æ¨¡æ‹Ÿç»“æœ';
            submitButton.title = 'ç”Ÿæˆæ”¹å–„æ•ˆæœå¯¹æ¯”åˆ†æ';
            buttonContainer.appendChild(submitButton);

            const resetButton = document.createElement('button');
            resetButton.className = 'simulation-reset';
            resetButton.onclick = resetSimulation;
            resetButton.innerHTML = '<i class="fas fa-undo"></i> é‡ç½®';
            resetButton.title = 'é‡ç½®æ‰€æœ‰æ”¹å–„ç™¾åˆ†æ¯”';
            buttonContainer.appendChild(resetButton);

            container.appendChild(buttonContainer);

            // æ·»åŠ é¥¼å›¾å®¹å™¨
            const chartsContainer = document.createElement('div');
            chartsContainer.className = 'pie-charts-container';
            
            // Beforeé¥¼å›¾å®¹å™¨
            const beforeWrapper = document.createElement('div');
            beforeWrapper.className = 'pie-chart-wrapper';
            const beforeCanvas = document.createElement('canvas');
            beforeCanvas.id = 'beforePieChart';
            beforeWrapper.appendChild(beforeCanvas);
            
            // Afteré¥¼å›¾å®¹å™¨
            const afterWrapper = document.createElement('div');
            afterWrapper.className = 'pie-chart-wrapper';
            const afterCanvas = document.createElement('canvas');
            afterCanvas.id = 'afterPieChart';
            afterWrapper.appendChild(afterCanvas);
            
            chartsContainer.appendChild(beforeWrapper);
            chartsContainer.appendChild(afterWrapper);
            dataComparisonDiv.appendChild(chartsContainer);
            
            // æ·»åŠ åˆ°ä¸»å®¹å™¨
            container.appendChild(dataComparisonDiv);

            return container;
        }

            function validatePercentage(input, suggestedMax) {
                const value = parseFloat(input.value);
                if (isNaN(value)) {
                    input.setCustomValidity('');
                    input.classList.remove('exceeds-suggestion');
                    return true;
                }
                
                if (value < 0) {
                    input.setCustomValidity('æ”¹å–„ç™¾åˆ†æ¯”ä¸èƒ½ä¸ºè´Ÿæ•°');
                    input.classList.remove('exceeds-suggestion');
                    return false;
                }
                
                // Remove strict validation, just show warning styling if exceeds suggestion
                if (value > suggestedMax) {
                    input.classList.add('exceeds-suggestion');
                } else {
                    input.classList.remove('exceeds-suggestion');
                }
                
                input.setCustomValidity('');
                return true;
            }

            function updateSimulationResults(e) {
                const input = e.target;
                const index = input.dataset.index;
                const maxPercentage = simulationData.maxPercentages[index];
                
                // éªŒè¯è¾“å…¥å€¼
                const isValid = validatePercentage(input, maxPercentage);
                if (!isValid) {
                    input.reportValidity();
                    return;
                }

                const baseValue = simulationData.baseValues[index];
                const percentage = parseFloat(input.value) || 0;

                // è®¡ç®—å½“å‰é¡¹çš„æ”¹å˜å€¼
                let result;
                if (baseValue < 0) {
                    result = baseValue * (1 - percentage / 100);
                } else {
                    result = baseValue * (1 + percentage / 100);
                }
                
                // æ›´æ–°å½“å‰å•å…ƒæ ¼ç»“æœ
                const resultCell = input.closest('tr').querySelector('.simulation-result');
                resultCell.textContent = result.toFixed(2);

                // æ›´æ–°æ”¹å–„æ•ˆæœæ ·å¼
                const row = input.closest('tr');
                const change = ((result - baseValue) / Math.abs(baseValue) * 100);
                row.setAttribute('data-improvement', change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral');

                // æ›´æ–°æ‰€æœ‰æ±‡æ€»æŒ‡æ ‡
                updateAggregateIndicators();

                // æ›´æ–°æ•°æ®å¯¹æ¯”è¡¨æ ¼å’Œå›¾è¡¨
                updateComparisonTable();
            }

            // æ·»åŠ æ”¹å–„æ•ˆæœæ ·å¼
            const improvementStyle = document.createElement('style');
            improvementStyle.textContent = `
                .simulation-table tr[data-improvement="positive"] {
                    background-color: rgba(76, 175, 80, 0.05);
                }

                .simulation-table tr[data-improvement="positive"]:hover {
                    background-color: rgba(76, 175, 80, 0.1);
                }

                .simulation-table tr[data-improvement="negative"] {
                    background-color: rgba(244, 67, 54, 0.05);
                }

                .simulation-table tr[data-improvement="negative"]:hover {
                    background-color: rgba(244, 67, 54, 0.1);
                }

                .simulation-table input:invalid {
                    border-color: #F44336;
                }

                .simulation-table input.exceeds-suggestion {
                    border-color: #FFB800;
                    background-color: rgba(255, 184, 0, 0.05);
                }

                .simulation-table input.exceeds-suggestion:focus {
                    box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.1);
                }

                .simulation-table input.exceeds-suggestion::after {
                    content: "âš ï¸";
                    position: absolute;
                    right: -24px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 16px;
                }

                .simulation-table .input-wrapper[data-suggestion]::after {
                    content: attr(data-suggestion);
                    position: absolute;
                    right: -80px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 12px;
                    color: #666;
                    white-space: nowrap;
                }
            `;
            document.head.appendChild(improvementStyle);

            function updateAggregateIndicators() {
                const gmmIndex = simulationData.labels.findIndex(l => l.includes('GMM'));
                const copaIndex = simulationData.labels.findIndex(l => l.includes('COPA'));
                const gpIndex = simulationData.labels.findIndex(l => l.includes('æ¯›åˆ©'));
                const operatingIncomeIndex = simulationData.labels.findIndex(l => l.includes('è¥ä¸šåˆ©æ¶¦'));
                const ebitdaIndex = simulationData.labels.findIndex(l => l.includes('EBITDA'));

                const resultCells = document.querySelectorAll('.simulation-result');
                const baseValues = simulationData.baseValues;

                // è·å–æ”¶å…¥å’Œæˆæœ¬æ•°æ®
                const totalRevenue = parseFloat(resultCells[0].textContent); // æ€»æ”¶å…¥
                const materialCost = parseFloat(resultCells[1].textContent); // ç›´æ¥ææ–™æˆæœ¬
                
                // è®¡ç®—GMM (æ€»æ”¶å…¥ + ç›´æ¥ææ–™æˆæœ¬ï¼Œå› ä¸ºæˆæœ¬æ˜¯è´Ÿå€¼)
                const gmmValue = totalRevenue + materialCost;
                resultCells[gmmIndex].textContent = gmmValue.toFixed(2);

                // è·å–åŒ…è£…å’Œå¤–åŒ…æˆæœ¬
                const packagingCost = parseFloat(resultCells[3].textContent); // åŒ…è£…æˆæœ¬
                const subcontractingCost = parseFloat(resultCells[4].textContent); // å¤–åŒ…æˆæœ¬
                
                // è®¡ç®—COPA (GMM + åŒ…è£…æˆæœ¬ + å¤–åŒ…æˆæœ¬ï¼Œéƒ½æ˜¯è´Ÿå€¼)
                const copaValue = gmmValue + packagingCost + subcontractingCost;
                resultCells[copaIndex].textContent = copaValue.toFixed(2);

                // è·å–äººå·¥å’Œé—´æ¥æˆæœ¬
                const directLabor = parseFloat(resultCells[6].textContent); // ç›´æ¥äººå·¥
                const indirectLabor = parseFloat(resultCells[7].textContent); // é—´æ¥äººå·¥
                const indirectCosts = parseFloat(resultCells[8].textContent); // é—´æ¥æˆæœ¬
                
                // è®¡ç®—GP (COPA + æ‰€æœ‰æˆæœ¬é¡¹ï¼Œéƒ½æ˜¯è´Ÿå€¼)
                const gpValue = copaValue + directLabor + indirectLabor + indirectCosts;
                resultCells[gpIndex].textContent = gpValue.toFixed(2);


                // è·å–è¿è¥ç›¸å…³è´¹ç”¨
                const operatingExp = parseFloat(resultCells[10].textContent);  // è¥ä¸šè´¹ç”¨
                const salesExp = parseFloat(resultCells[11].textContent);      // é”€å”®è´¹ç”¨
                const gaExp = parseFloat(resultCells[12].textContent);         // ç®¡ç†è´¹ç”¨
                const rdExp = parseFloat(resultCells[13].textContent);         // ç ”å‘è´¹ç”¨

                // è®¡ç®—è¥ä¸šåˆ©æ¶¦ (GP + æ‰€æœ‰è´¹ç”¨é¡¹)
                const operatingIncome = gpValue + operatingExp + salesExp + gaExp + rdExp;
                resultCells[operatingIncomeIndex].textContent = operatingIncome.toFixed(2);

                // è®¡ç®—EBITDAçš„å˜åŒ–å€¼ï¼šç­‰äºè¥ä¸šåˆ©æ¶¦çš„å˜åŒ–å€¼
                const operatingIncomeChange = operatingIncome - baseValues[operatingIncomeIndex];
                // EBITDAæœ€ç»ˆå€¼ = EBITDAåŸå€¼ + è¥ä¸šåˆ©æ¶¦çš„å˜åŒ–å€¼
                const ebitdaValue = baseValues[ebitdaIndex] + operatingIncomeChange;
                resultCells[ebitdaIndex].textContent = ebitdaValue.toFixed(2);

                // æ›´æ–°æ±‡æ€»æŒ‡æ ‡çš„æ”¹å–„ç™¾åˆ†æ¯”æ˜¾ç¤º
                const percentageDisplays = document.querySelectorAll('.percentage-display');
                const indicators = [
                    { index: gmmIndex, label: 'GMM' },
                    { index: copaIndex, label: 'COPA' },
                    { index: gpIndex, label: 'GP' },
                    { index: operatingIncomeIndex, label: 'Operating Income' },
                    { index: ebitdaIndex, label: 'EBITDA' }
                ];

                indicators.forEach((indicator, i) => {
                    const originalValue = baseValues[indicator.index];
                    const currentValue = parseFloat(resultCells[indicator.index].textContent);
                    const changePercentage = ((currentValue - originalValue) / Math.abs(originalValue) * 100).toFixed(2);
                    const percentageSpan = percentageDisplays[i];
                    
                    // æ›´æ–°æ˜¾ç¤º
                    percentageSpan.textContent = (changePercentage > 0 ? '+' : '') + changePercentage + '%';
                    percentageSpan.setAttribute('data-positive', changePercentage > 0);
                    
                    // æ·»åŠ æŒ‡æ ‡åç§°æç¤º
                    percentageSpan.title = `${indicator.label} æ”¹å–„å¹…åº¦`;
                });
            }

            function updateComparisonTable() {
                const results = getSimulationResults();
                const positiveResults = results.filter(v => v > 0);
                const totalAfter = positiveResults.reduce((a, b) => a + b, 0);
                
                // è·å–æ‰€æœ‰æ­£æ•°å€¼çš„åŸå§‹æ•°æ®è¡Œ
                const comparisonRows = document.querySelectorAll('.comparison-table tbody tr');
                let currentIndex = 0;
                
                results.forEach((value, index) => {
                    if (value > 0) {
                        const row = comparisonRows[currentIndex];
                        if (row) {
                            const baseValue = simulationData.baseValues[index];
                            const totalBefore = simulationData.baseValues
                                .filter(v => v > 0)
                                .reduce((a, b) => a + b, 0);
                            
                            const beforePercentage = ((baseValue / totalBefore) * 100).toFixed(1);
                            const afterPercentage = ((value / totalAfter) * 100).toFixed(1);
                            const change = ((value - baseValue) / baseValue * 100).toFixed(1);
                            
                            // æ›´æ–°è¡¨æ ¼å•å…ƒæ ¼
                            row.children[3].textContent = value.toFixed(2); // æ”¹å–„åæ•°å€¼
                            row.children[4].textContent = afterPercentage + '%'; // æ”¹å–„åå æ¯”
                            
                            const changeText = (change > 0 ? '+' : '') + change + '%';
                            const changeCell = row.children[5];
                            changeCell.textContent = changeText;
                            changeCell.setAttribute('data-change', changeText);
                        }
                        currentIndex++;
                    }
                });
            }

        function getSimulationResults() {
            const results = [];
            document.querySelectorAll('.simulation-result').forEach(cell => {
                results.push(parseFloat(cell.textContent));
            });
            return results;
        }

        let beforePieChart = null;
        let afterPieChart = null;

            function resetSimulation() {
                // é‡ç½®æ‰€æœ‰è¾“å…¥æ¡†
                document.querySelectorAll('.simulation-table input').forEach(input => {
                    input.value = '';
                    input.setCustomValidity(''); // æ¸…é™¤éªŒè¯çŠ¶æ€
                    input.closest('tr').removeAttribute('data-improvement'); // ç§»é™¤æ”¹å–„æ•ˆæœæ ·å¼
                });

                // é‡ç½®æ‰¹é‡è°ƒæ•´è¾“å…¥
                const batchInput = document.querySelector('.batch-input');
                batchInput.value = '';
                batchInput.setCustomValidity('');

                // é‡ç½®æ‰€æœ‰ç»“æœå•å…ƒæ ¼
                document.querySelectorAll('.simulation-result').forEach((cell, index) => {
                    cell.textContent = simulationData.baseValues[index];
                });
                
                // é‡ç½®æ‰€æœ‰ç™¾åˆ†æ¯”æ˜¾ç¤º
                document.querySelectorAll('.percentage-display').forEach(span => {
                    span.textContent = '0.00%';
                    span.removeAttribute('data-positive');
                    span.title = ''; // æ¸…é™¤æç¤ºæ–‡æœ¬
                });
                
                // é‡ç½®å¯¹æ¯”è¡¨æ ¼æ•°æ®å’ŒåŠ¨ç”»
                const comparisonRows = document.querySelectorAll('.comparison-table tbody tr');
                comparisonRows.forEach(row => {
                    const baseValue = parseFloat(row.children[1].textContent);
                    row.children[3].textContent = baseValue.toFixed(2);
                    row.children[4].textContent = row.children[2].textContent;
                    
                    const changeCell = row.children[5];
                    changeCell.textContent = '0.0%';
                    changeCell.removeAttribute('data-change');
                    
                    // ç§»é™¤æ‰€æœ‰åŠ¨ç”»ç›¸å…³çš„ç±»
                    row.classList.remove('highlight-positive', 'highlight-negative');
                });
                
                // é‡ç½®å›¾è¡¨
                updateCharts();
                
                // æ˜¾ç¤ºé‡ç½®å®Œæˆçš„åé¦ˆ
                const resetButton = document.querySelector('.simulation-reset');
                resetButton.classList.add('button-flash');
                setTimeout(() => resetButton.classList.remove('button-flash'), 500);
            }

            // æ·»åŠ ç™¾åˆ†æ¯”æ˜¾ç¤ºæ ·å¼
            const percentageStyle = document.createElement('style');
            percentageStyle.textContent = `
                .percentage-display {
                    display: inline-block;
                    padding: 6px 12px;
                    border: 2px solid transparent;
                    border-radius: 4px;
                    background-color: #f8f9fa;
                    font-family: 'Consolas', monospace;
                    text-align: right;
                    width: 100px;
                    transition: all 0.3s ease;
                }

                .percentage-display[data-positive="true"] {
                    color: #4CAF50;
                    border-color: rgba(76, 175, 80, 0.2);
                }

                .percentage-display[data-positive="false"] {
                    color: #F44336;
                    border-color: rgba(244, 67, 54, 0.2);
                }
            `;
            document.head.appendChild(percentageStyle);

        function updateCharts() {
            // å¤„ç†é¥¼å›¾æ•°æ®ï¼šä½¿ç”¨æˆæœ¬å’Œè´¹ç”¨çš„ç»å¯¹å€¼åŠ ä¸Šè¥ä¸šåˆ©æ¶¦
            function processChartData(values) {
                const processedData = [];
                const processedLabels = [];
                const processedColors = [];
                
                values.forEach((value, index) => {
                    // ç­›é€‰å‡ºæˆæœ¬ã€è´¹ç”¨ï¼ˆè´Ÿå€¼ï¼‰å’Œè¥ä¸šåˆ©æ¶¦
                    if (value < 0 || simulationData.labels[index].includes('è¥ä¸šåˆ©æ¶¦')) {
                        processedData.push(Math.abs(value));
                        processedLabels.push(simulationData.labels[index]);
                        processedColors.push(simulationData.colors[index]);
                    }
                });
                return { data: processedData, labels: processedLabels, colors: processedColors };
            }

            const beforeResults = processChartData(simulationData.baseValues);
            const afterResults = processChartData(getSimulationResults());

            if (beforePieChart) beforePieChart.destroy();
            if (afterPieChart) afterPieChart.destroy();

            const pieOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 12, family: 'Arial' },
                            padding: 15,
                            usePointStyle: true,
                            boxWidth: 8,
                            color: '#333'
                        }
                    },
                    title: {
                        padding: {
                            bottom: 25
                        },
                        color: '#333',
                        font: {
                            size: 16,
                            weight: 'bold',
                            family: 'Arial'
                        }
                    },
                        tooltip: {
                            animation: {
                                duration: 150,
                                easing: 'easeOutQuad'
                            },
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            titleColor: '#333',
                            titleFont: {
                                size: 14,
                                weight: 'bold',
                                family: 'Arial'
                            },
                            bodySpacing: 8,
                            bodyColor: '#666',
                            bodyFont: {
                                size: 13,
                                family: 'Arial'
                            },
                            padding: 16,
                            boxPadding: 8,
                            borderColor: '#e0e0e0',
                            borderWidth: 1,
                            cornerRadius: 8,
                            usePointStyle: true,
                            boxWidth: 8,
                            displayColors: true,
                            caretSize: 8,
                            caretPadding: 6,
                            callbacks: {
                                title: function(items) {
                                    return items[0].label;
                                },
                                label: function(context) {
                                    const value = Math.abs(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);

                                    // Get the corresponding before/after value
                                    const label = context.label;
                                    const isAfterChart = context.chart.canvas.id === 'afterPieChart';
                                    const beforeValue = beforeResults.data[beforeResults.labels.indexOf(label)];
                                    const afterValue = afterResults.data[afterResults.labels.indexOf(label)];
                                    
                                    if (isAfterChart) {
                                        const change = ((afterValue - beforeValue) / beforeValue * 100).toFixed(1);
                                        const changeText = change > 0 ? `+${change}%` : `${change}%`;
                                        const color = change > 0 ? '#4CAF50' : '#F44336';
                                        return [
                                            `æ•°å€¼: ${value.toFixed(2)}`,
                                            `å æ¯”: ${percentage}%`,
                                            `å˜åŒ–: ${changeText}`,
                                        ];
                                    } else {
                                        return [
                                            `æ•°å€¼: ${value.toFixed(2)}`,
                                            `å æ¯”: ${percentage}%`
                                        ];
                                    }
                                },
                                labelTextColor: function(context) {
                                    return '#666';
                                }
                            }
                        }
                }
            };

            beforePieChart = new Chart(document.getElementById('beforePieChart'), {
                type: 'pie',
                data: {
                    labels: beforeResults.labels,
                    datasets: [{
                        data: beforeResults.data,
                        backgroundColor: beforeResults.colors
                    }]
                },
                options: {
                    ...pieOptions,
                    plugins: {
                        ...pieOptions.plugins,
                        title: {
                            display: true,
                            text: 'æ”¹å–„å‰è¥è¿æˆæœ¬ç»“æ„',
                            font: { size: 16 }
                        }
                    }
                }
            });

            afterPieChart = new Chart(document.getElementById('afterPieChart'), {
                type: 'pie',
                data: {
                    labels: afterResults.labels,
                    datasets: [{
                        data: afterResults.data,
                        backgroundColor: afterResults.colors
                    }]
                },
                options: {
                    ...pieOptions,
                    plugins: {
                        ...pieOptions.plugins,
                        title: {
                            display: true,
                            text: 'æ”¹å–„åè¥è¿æˆæœ¬ç»“æ„',
                            font: { size: 16 }
                        }
                    }
                }
            });

            // æ·»åŠ æäº¤æŒ‰é’®åŠ¨ç”»æ•ˆæœ
            const submitButton = document.querySelector('.simulation-submit');
            submitButton.classList.add('button-flash');
            setTimeout(() => submitButton.classList.remove('button-flash'), 500);
            
            // æ›´æ–°æ•°æ®å¯¹æ¯”è¡¨æ ¼
            updateComparisonTable();
        }

        // CSS æ ·å¼æ·»åŠ 
        const style = document.createElement('style');
        style.textContent = `
            .simulation-table-container {
                margin-top: 20px;
                padding: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .simulation-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
            }

            .simulation-table th,
            .simulation-table td {
                padding: 12px;
                text-align: left;
                border: 1px solid #e0e0e0;
            }

            .simulation-table th {
                background-color: var(--color-primary);
                color: white;
                font-weight: bold;
            }

            .simulation-table tr.positive-value {
                background-color: rgba(0, 181, 247, 0.05);
            }

            .simulation-table tr.positive-value:hover {
                background-color: rgba(0, 181, 247, 0.1);
            }

            .simulation-table input {
                width: 160px;
                padding: 8px 32px 8px 12px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                transition: all 0.3s ease;
                font-family: 'Consolas', monospace;
                font-size: 14px;
                color: #333;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .simulation-table input:hover {
                border-color: var(--color-tertiary);
            }

            .simulation-table input:focus {
                outline: none;
                border-color: var(--color-tertiary);
                box-shadow: 0 0 0 3px rgba(0, 181, 247, 0.1);
                background-color: white;
            }

            .simulation-table input:invalid {
                border-color: #F44336;
                background-color: rgba(244, 67, 54, 0.03);
                box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
            }

            .simulation-table input::placeholder {
                color: #999;
                font-size: 0.9em;
                font-style: italic;
            }

            .simulation-table .input-wrapper {
                position: relative;
                display: inline-flex;
                align-items: center;
            }

            .simulation-table .input-wrapper::after {
                position: absolute;
                right: 10px;
                color: #666;
                font-size: 14px;
                pointer-events: none;
                opacity: 0.8;
                font-family: Arial, sans-serif;
            }

            .input-wrapper {
                position: relative;
                display: inline-block;
            }

            .input-wrapper::after {
                content: '%';
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                color: #666;
                pointer-events: none;
            }

            .button-container {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            .simulation-submit,
            .simulation-reset {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .simulation-submit {
                background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
                color: white;
                flex: 2;
            }

            .simulation-reset {
                background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
                color: #666;
                flex: 1;
            }

            .simulation-submit i,
            .simulation-reset i {
                font-size: 16px;
                transition: transform 0.3s ease;
            }

            .simulation-submit:hover,
            .simulation-reset:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

            .simulation-submit:hover i {
                transform: rotate(180deg);
            }

            .simulation-reset:hover i {
                transform: scale(1.2);
            }

            .simulation-submit:active,
            .simulation-reset:active {
                transform: translateY(0);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .button-container {
                display: flex;
                gap: 15px;
                margin: 30px 0;
                padding: 0 15px;
            }

            .pie-charts-container {
                display: flex;
                gap: 20px;
                margin-top: 20px;
                height: 400px;
            }

            .data-comparison-section {
                margin-top: 30px;
                padding: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .comparison-title {
                color: var(--color-primary);
                margin: 0 0 20px 0;
                font-size: 18px;
            }

            .pie-charts-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
                gap: 30px;
                margin: 30px 0;
                min-height: 450px;
                align-items: stretch;
            }

            @media (max-width: 900px) {
                .pie-charts-container {
                    grid-template-columns: 1fr;
                    gap: 20px;
                }
            }

            .pie-chart-wrapper {
                background: white;
                border-radius: 12px;
                padding: 25px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                transition: all 0.3s ease;
            }

            .pie-chart-wrapper:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(0,0,0,0.15);
            }

            .pie-chart-wrapper canvas {
                flex: 1;
                width: 100% !important;
                height: auto !important;
                min-height: 350px;
                max-height: 450px;
            }

            @keyframes button-flash {
                0% { background-color: var(--color-primary); }
                50% { background-color: var(--color-secondary); }
                100% { background-color: var(--color-primary); }
            }

            .button-flash {
                animation: button-flash 0.5s ease;
            }

            .simulation-table td[class^="base-value"],
            .simulation-table td[class^="simulation-result"],
            .comparison-table td[class^="value"],
            .comparison-table td[class^="percentage"] {
                font-family: 'Consolas', monospace;
                text-align: right;
            }

            .comparison-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                margin-top: 20px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                overflow: hidden;
            }

            .comparison-table th,
            .comparison-table td {
                padding: 14px;
                border-bottom: 1px solid #e0e0e0;
                border-right: 1px solid #e0e0e0;
                position: relative;
            }

            .comparison-table th {
                background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
                color: white;
                font-weight: bold;
                white-space: nowrap;
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }

            .comparison-table tr:last-child td {
                border-bottom: none;
            }

            .comparison-table td:last-child,
            .comparison-table th:last-child {
                border-right: none;
            }

            .comparison-table td.value {
                text-align: right;
                font-family: 'Consolas', monospace;
                font-size: 14px;
                color: #333;
            }

            .comparison-table td.percentage {
                text-align: right;
                font-family: 'Consolas', monospace;
                font-size: 14px;
                transition: all 0.3s ease;
                position: relative;
            }

            .comparison-table td.percentage[data-change^="+"] {
                color: #4CAF50;
                animation: highlight-positive 0.5s ease;
            }

            .comparison-table td.percentage[data-change^="+"]::before {
                content: "â–²";
                position: absolute;
                left: 4px;
                color: #4CAF50;
            }

            .comparison-table td.percentage[data-change^="-"] {
                color: #F44336;
                animation: highlight-negative 0.5s ease;
            }

            .comparison-table td.percentage[data-change^="-"]::before {
                content: "â–¼";
                position: absolute;
                left: 4px;
                color: #F44336;
            }

            @keyframes highlight-positive {
                0% { background-color: rgba(76, 175, 80, 0.2); }
                100% { background-color: transparent; }
            }

            @keyframes highlight-negative {
                0% { background-color: rgba(244, 67, 54, 0.2); }
                100% { background-color: transparent; }
            }

            .comparison-table tr:hover {
                background-color: rgba(0, 181, 247, 0.05);
            }

            .comparison-table tr {
                transition: all 0.3s ease;
            }

            .comparison-table tr:nth-child(even) {
                background-color: #f8f9fa;
            }

            .comparison-table tr:last-child td:first-child {
                border-bottom-left-radius: 8px;
            }

            .comparison-table tr:last-child td:last-child {
                border-bottom-right-radius: 8px;
            }

            .comparison-table th:first-child {
                border-top-left-radius: 8px;
            }

            .comparison-table th:last-child {
                border-top-right-radius: 8px;
            }
        `;
        document.head.appendChild(style);

        // åˆå§‹åŒ–
        document.getElementById('tree-container').appendChild(createTreeNode(treeData));
        
        // æ·»åŠ æ¨¡å—4åˆ°é¡µé¢
        const simulationSection = document.createElement('div');
        simulationSection.className = 'section';
        simulationSection.innerHTML = `
            <h2 class="section-title">
                <i class="fas fa-calculator"></i>
                æ¨¡å—4ï¼šæ”¹å–„æ•ˆæœæ¨¡æ‹Ÿ
            </h2>
            <p class="section-connection">
                åŸºäºæ¨¡å—2çš„æ•°æ®è¿›è¡Œæ”¹å–„æ¨¡æ‹Ÿï¼Œé€šè¿‡è°ƒæ•´å„é¡¹æŒ‡æ ‡çš„æ”¹å–„ç™¾åˆ†æ¯”ï¼Œç›´è§‚å±•ç¤ºæ”¹å–„æ•ˆæœ
            </p>
        `;
        simulationSection.appendChild(createSimulationTable());
        document.querySelector('.container').appendChild(simulationSection);

        // åˆå§‹åŒ–é¥¼å›¾
        updateCharts();
    </script>
</body>
</html>
